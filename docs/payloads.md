# Parser → Graph → Viz Payload Contract

Plan references: PLAN.md §§3.6, 3.7, 10.4.  
Scope: Defines the shared JSON structures exchanged between the parser, graph/analysis pipeline, storage layer, and visualization UI.

## 1. Overview

All agents exchange *immutable* payloads composed of:

- `functions[]` — function metadata emitted by the parser.
- `callEdges[]` — directed call relationships (parser output).
- `similarityEdges[]` — undirected semantic relationships (embeddings output).
- Optional `extras` — ancillary metadata (symbol tables, stats, snapshots).

Payloads **must be serializable JSON** (no prototypes, Maps, Sets). Each record is keyed by the function `id` string; downstream systems treat `id` as globally unique within a session.

## 2. Function Records (`functions[]`)

```json
{
  "id": "src/utils/math.ts::add",
  "name": "add",
  "fqName": "utils.math.add",
  "filePath": "src/utils/math.ts",
  "moduleId": "utils.math",
  "lang": "typescript",
  "isVirtual": false,
  "startLine": 12,
  "endLine": 24,
  "startColumn": 0,
  "endColumn": 1,
  "loc": 13,
  "doc": "Adds two numbers.",
  "source": "function add(a,b){...}",
  "metrics": {
    "cyclomatic": 3,
    "centralityScore": 0.418
  },
  "analysis": {
    "community": 4,
    "coreNumber": 3,
    "centralityDetails": {
      "pageRank": 0.0123,
      "betweenness": 0.0041,
      "degree": { "total": 8, "in": 5, "out": 3 }
    }
  }
}
```

### Required fields

| Field | Type | Notes |
| --- | --- | --- |
| `id` | string | Stable identifier. Preferred format: `<filePath>::<name or hash>`. |
| `name` | string | Local name (may be empty for anonymous functions). |
| `filePath` | string | Normalized POSIX path relative to project root. |
| `lang` | enum | `"javascript"`, `"typescript"`, `"python"`, … (lowercase). |
| `startLine`, `endLine` | number | 1-based, inclusive. |

### Recommended fields

- `fqName`: dotted namespace (module + name).  
- `moduleId`: parser’s module graph identifier.  
- `loc`: lines of code (fallback: `endLine - startLine + 1`).  
- `doc`: trimmed docstring / first comment.  
- `metrics`: bag for static metrics (cyclomatic, halstead, etc.).  
- `analysis`: Graphology outputs. When present, keep nested objects JSON-friendly (no Maps, no class instances).

### Optional fields

- `startColumn` / `endColumn`: 0-based columns.  
- `source`: small snippet (used in inspector/resume). Trim large bodies per PLAN.md §6 limits.  
- `isVirtual`: `true` when synthesized (e.g., module initializers).

## 3. Call Edges (`callEdges[]`)

Directed, potentially multi-edge if multiple resolutions are returned. Downstream loaders collapse duplicates by `(callerId, calleeId)` while retaining metadata.

```json
{
  "id": "call::src/main.ts::bootstrap→src/utils/logger.ts::log",
  "source": "src/main.ts::bootstrap",
  "target": "src/utils/logger.ts::log",
  "weight": 2,
  "isDynamic": false,
  "language": "typescript",
  "callSites": [
    {
      "filePath": "src/main.ts",
      "line": 42,
      "column": 8,
      "context": "logger.log('init');"
    }
  ],
  "metadata": {
    "importInfo": {
      "specifiers": ["log"],
      "module": "./utils/logger"
    },
    "callSiteSamples": []
  },
  "resolution": {
    "status": "resolved",
    "reason": null,
    "candidates": [
      {
        "id": "src/utils/logger.ts::log",
        "confidence": 0.92
      }
    ],
    "importInfo": {
      "module": "./utils/logger",
      "resolvedModule": "utils.logger"
    }
  }
}
```

### Required fields

| Field | Type | Notes |
| --- | --- | --- |
| `source` | string | Caller function `id`. |
| `target` | string | Callee function `id` (for resolved edges). |
| `weight` | number | Number of call sites (minimum `1`). |

### Recommended fields

- `id`: Optional unique edge identifier (stable for storage).  
- `isDynamic`: `true` when reflection/dynamic dispatch involved.  
- `language`: copy of parser language.  
- `callSites[]`: list of per-site details (`filePath`, `line`, `column`, optional `context`).  
- `metadata`: free-form bag for parser extras (e.g., AST node types).  
- `resolution`: structured outcome:
  - `status`: `"resolved" | "ambiguous" | "unresolved"`.
  - `reason`: human-readable explanation when not resolved.
  - `candidates[]`: `{ id, confidence }` for ambiguous resolutions.
  - `importInfo`: `{ module, resolvedModule, specifiers[] }`.

### Interpretation

- Viz treats missing `target` or `status !== 'resolved'` as unresolved/ambiguous edges (styled accordingly).  
- Graph-core expects `source/target` to reference ids present in `functions[]`. If unresolved, leave `target` equal to best guess and set `resolution.status` appropriately.

## 4. Similarity Edges (`similarityEdges[]`)

Undirected semantic edges generated by embeddings. Visualization expects weights in `[0,1]` with higher = more similar.

```json
{
  "id": "sim::src/utils/math.ts::add↔src/utils/math.ts::sum",
  "source": "src/utils/math.ts::add",
  "target": "src/utils/math.ts::sum",
  "similarity": 0.84,
  "method": "topk-avg",
  "representativeSimilarity": 0.81,
  "topPairs": [
    { "sourceChunk": "chunk-1", "targetChunk": "chunk-9", "score": 0.92 }
  ],
  "undirected": true,
  "metadata": {
    "bundleSize": 3,
    "model": "miniLM-L6-v2"
  }
}
```

### Required fields

| Field | Type | Notes |
| --- | --- | --- |
| `source` | string | Function `id`. |
| `target` | string | Function `id`. |
| `similarity` | number | Cosine similarity (0–1). |

### Recommended fields

- `id`: Optional deterministic identifier.  
- `method`: e.g., `"topk-avg"`, `"representative-dot"`.  
- `topPairs[]`: `{ sourceChunk, targetChunk, score }` for inspector detail.  
- `representativeSimilarity`: aggregated score after chunk pruning.  
- `metadata`: catch-all for embedding config (model, k, projection counts).

### Interpretation

- Edges are assumed symmetric; viz toggles treat them as undirected.  
- Graph pipeline normalizes missing fields (defaults to weight = similarity, undirected = true).

## 5. Payload Envelope

When orchestrating the full pipeline, we exchange an envelope:

```json
{
  "parser": {
    "functions": [ ... ],
    "callEdges": [ ... ],
    "stats": {
      "totalEdges": 420,
      "resolvedEdges": 400,
      "ambiguousEdges": 12,
      "unresolvedEdges": 8
    },
    "symbolTables": { "src/main.ts": { "moduleId": "app.main", "exports": [], "imports": [] } }
  },
  "embeddings": {
    "similarityEdges": [ ... ],
    "metadata": {
      "backend": "webgpu",
      "modelId": "Xenova/all-MiniLM-L6-v2",
      "dimension": 384
    },
    "stats": {
      "chunkCount": 1580,
      "reuse": { "reused": 940, "embedded": 640 }
    },
    "functionEmbeddings": [
      {
        "id": "src/utils/math.ts::add",
        "vector": [0.12, ...],
        "sourceChunks": ["chunk-1", "chunk-3"]
      }
    ]
  },
  "overrides": {
    "functions": [ ... ],
    "callEdges": [ ... ],
    "similarityEdges": [ ... ]
  },
  "extras": {
    "analysisSummary": { /* graph metrics */ },
    "layoutSnapshotId": "layout::hash"
  }
}
```

- `parser` and `embeddings` sections mirror current `updateGraphData` inputs.  
- `overrides` allow agents to inject preprocessed payloads (bypassing auto-collection).  
- `extras` is optional; consumers must tolerate missing keys.

## 6. Validation Checklist

- Every `source`/`target` references a function present in `functions[]`.  
- No circular JSON structures.  
- All numbers Finite (`Number.isFinite` check).  
- Strings normalized to UTF-8; paths use forward slashes.  
- Large text fields (e.g., `source`) trimmed per PLAN §6 (`MAX_SOURCE_CHAR_LENGTH`, `MAX_SOURCE_LINES`).

## 7. Versioning & Future Work

- Schema evolution should be additive. New fields must be optional with sensible defaults.  
- Breaking changes require coordinated updates to `docs/payloads.md`, `collectGraphPayload`, and downstream tests.  
- Future additions (planned):
  - Worker message envelopes referencing these shapes.
  - Signed schema hash to detect mismatches between agents.

Refer to this document when updating parser exporters, graph merge helpers, or visualization loaders to ensure cross-agent compatibility.

